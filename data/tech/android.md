# rikumi ❤ Android

rikumi 自述文档系列之二

> 2 年 Android 反编译经验，2 年 Android 学习经验，1 年业务开发经验，基于 Android Studio 和 Java；
>
> 会 Swift 是不是等于会一半 Kotlin 了呢？🤔
>
> 熟练掌握 Android 基本布局，本地存储，本地数据库，`OKHTTP`/`ButterKnife` 等库的使用，熟悉 Android 业务应用、`Service`、`Widget` 的开发。

项目经历：

- 高中两年反编译修改「Flyme 音乐」「Flyme 文件管理」「Flyme 软件包安装程序」「Flyme 日历」「SystemUI 系统用户界面」等系统应用
- 通过系统事件、图片编解码、Smali 字节码注入等~~不入流~~技术，使「SystemUI 系统用户界面」配合「Flyme 音乐」在状态栏展示伪沉浸背景图片
- 「云果音乐」本地音乐播放器（使用 AIDE 开发）不使用任何第三方库，实现了媒体库扫描、播放列表、播放界面、播放模式、后台播放、歌词解析、专辑图旋转、歌词渐变等功能
- 「LRC 歌词编辑器」（使用 AIDE 开发）不使用任何第三方库实现了 LRC 歌词手工同步、标签增删改、批量替换、效果预览等功能
- 「小猴偷米」Android 版参与开发和主持重构（70%，半年）
- 「[小球成长记2](https://github.com/rikumi/ballcraft)」仿「球球大作战」单机小游戏，使用 Canvas，不使用任何第三方库实现二维物理引擎、碰撞判断、视野缩放、球体分裂、球体聚合、吞噬算法、以及基于二次差分模拟引/斥力加速度的 AI 算法

♪524149927

本期 **BGM** ~~「驿动的心」~~来自「少女終末旅行」。在世界崩坏的尽头，少女作别了昔日的宁静，坐上钢铁的战车，从机械城市的最底层出发，开始了求索的旅程。

本期文档含有较多卖关子内容，不想听太多故事的可以手动**跳到下一个分割线**。

---

作为一个常年客串产品经理的开发狗，常常以一个业余互联网产品观察者的姿态看世界。

上篇提到的初中时代，除了自己搭建论坛和折腾学习机，同时还见证了中国互联网创业的第一批红利。初高中的时候，先后接触了这些东西：

1. 人人网，可以说打响了 2008 年开始的互联网创业战的第一枪。六年级的时候接触人人网，和老师和一部分有条件的同学一起玩，其乐无穷。到了今天，互联网社交已经逐渐淡化，人们从使用互联网维护一个社交圈子，逐渐变成使用互联网表达自己。
2. 腾讯微博、新浪微博。当时有舆论认为新浪是抄袭腾讯微博，所以一直在用腾讯微博，直到后来腾讯微博跟 QQ 空间越走越近，新浪微博则摆脱了熟人社交的老路，走出了一条自媒体传播的新路。
3. 开开网，是当时出现的一个基于位置的社交平台，有点像现在大众点评的雏形，后来倒闭了。
4. 微信，在塞班时代是一个非常有开创性的东西，使用方便，功能恰到好处，当时一直以为微信以后会像 QQ 一样臃肿，以至于现在特别庆幸微信依然是一个（至少在功能上）非常纯净的平台。
5. 点点网，是一个轻博客网站，也是后来网易 LOFTER 的雏形。点点网现在已经成为一个功能完全坏掉的僵尸网站，不知道为什么还在运行，可能是因为主站托管在不要钱的第三方平台上，团队跑路的时候没给网站下线。
6. 可能是高中时代出现的知乎，知乎第一次投广告的时候，广告 Banner 的设计吸引了我。那是我第一次主动点击广告。当时成为了知乎的第一批测试用户，亲眼见证了这个网站从零到一的诞生。

然而，那段时光最牵动我的依然是 Windows 端桌面软件的变化。传统音乐软件千千静听，在被百度收购的前夜，坚持着自己丰富的功能，以至于后来千千静听「消失」之后，歌词编辑工具这个领域出现了长期的空缺；新兴音乐软件 [Airplay](https://www.iplaysoft.com/airplay.html)（不是苹果的那个流媒体协议）凭借全毛玻璃 UI、仅 KB 级即可软解各种有损无损音乐格式的强大能力，也受到了一大批用户的追捧。

![](data/img/2018-02-09-airplay3.png)

后来，千千静听还是不可避免地离开了；Airplay 开发者因为与公司发生[合同冲突](http://tieba.baidu.com/p/3667577336)，也不再继续开发。随着 Windows 桌面端软件的集体引咎，桌面互联网的战局草草收场，把话语权交给了移动端。

初二那一年，上面说的这些变化还都没有发生。在混迹步步高论坛、修改学习机程序、以建站为乐趣的同时，我认识了原鱼鱼桌面秀、后来的[酷鱼桌面](https://www.iplaysoft.com/ku-yu.html)的作者 Tony，跟他们一起做酷鱼桌面的社区和资源库。在后来逐渐成长为千人至万人级的酷鱼桌面社区里，我的 UID 是一位数。

![](data/img/2018-02-09-kuyu.png)

因为也是基于 Discuz，上手比较快，操作也比较顺手，曾经在一次排查用户中心不能修改资料的 bug 中删了库，上千个刚从老资源库站上人工搬运过来的小工具资源化为乌有。Tony 团队非常宽容，号召了几十号人连夜又搬了一次，也没有追究我什么责任。

再后来，我就一直做酷鱼桌面的忠实用户，利用酷鱼做了很多神奇的东西，比如在班级电脑桌面上放一个精心美化的动态课表之类的东西，高中的时候，还给桌面课表加了上下课的语音播报（后来被喜欢拖堂的老师喝茶，撤掉了这个功能）。

---

交代了这么多背景故事之后，这篇文章终于开始进入正题。

高一的时候，自己的第三部诺基亚手机 C5-03 开始不听使唤，本来就难按压的电阻屏开始接触不良，必须要一只手用力按着屏幕上方的排线勉强使用。于是，经过了一些死皮赖脸的求助，意外收到了群里**大狗**同学无偿寄来的二手魅族 M9，那是我第一部安卓手机。

虽然之前用过家里的其它安卓机，但是用 M9 的体验跟当时的其他手机大不相同：当时的其他安卓机几乎都是传统的 160 ppi 大果粒屏，M9 比肩 iPhone 4s 的 320ppi 视网膜屏幕十分惊艳；Flyme 1.x 的体验在一众被改残的原生 Android 4.0 ROM 中完全是一股清流。事实也证明，Flyme 的美学生涯截止到 3.x。在后来 Flyme 4.0 出现之后，这个 ROM 已经死透了。

幸运的是，M9 的 ROM 止步于 Flyme 1.2。刚拿到手机的第一件事就是刷机，挑选一个最适合日常使用的版本；定制，装一些 Launcher 和小工具来做一些简单美化……在舒适的 UI 映衬下，一些不舒适的地方开始凸显出来。当时的我已经「身经百战」了，很清楚自己下一步该做什么了：改。

不论会不会。很快的工夫，在应用商店找到了 APKTool 这个东西，然后便走上了一条不归路。

![](data/img/2018-02-11-391518358364_.pic_hd.jpg)

上图是从原版到极限魔改，Flyme 音乐 1.2 的各种不同版本。中间克服了各种各样的困难，从零开始自己摸索出了 `FrameLayout`/`LinearLayout`/`RelativeLayout`的各种布局规律，在不影响 Java 层调取的前提下，把界面各个元素做了个乾坤大挪移。

![](data/img/2018-02-11-401518358868_.pic_hd.jpg)

套用系统主题 `@android:theme/deviceDefault_light`（有点忘了是不是这么写的名字），魔改版的 RE 管理器、APKTool 和两个版本的桌面（酷鱼小工具 + 魔改系统音乐小工具 + Flyme 2 图标包）。丝毫不顾忌两位数的高考倒计时，每天中午晚上在家的时间，从来都是被**修改→编译→签名→移动→改权限→测试**所占据。有一次晚上像往常一样躺在床上摆弄，刚改好代码，打开 APKTool，困意袭来，脑子不自觉开了个小差；等自己清醒过来，眼前的情况吓了我一跳：编译签名好的 apk 已经躺在系统目录了。**原来从编译到改权限的一套流程，已经形成了肌肉记忆。**

是的，你有没有注意到，当时**酷鱼小工具出了安卓版**，我是第一批内测用户。那段时间，我一直在酷鱼的群里水着，跟 T 大关系也不错，经常听他说一些很厉害的新功能，我也在做着我的反编译，井水不犯河水。直到有一天，T 大跟我说，**你为什么不去学学 Android 开发呢**？很好学而且也很有前景的。

——到那天为止，我还只写过 C++、Pascal 和桌面版酷鱼的 JS 脚本。到那天为止，我从来还没有想过自己可以开发一款 App，能做一个自己真真切切可以用到的东西。

于是，带着这句话给我的鼓舞，我去学了 Android 开发的基础。我的学习有一个特质：至多跟人走一步。学安卓的时候也是，**只学了一课，学到 `findViewById`**。剩下的所有知识，靠自己踩坑，靠搜索，靠蒙。我刚学 Android 的时候，还没有 Android Studio 呢，靠那个安装比登天还难的 Eclipse ADT 勉强撑着。再后来呢，有了 AIDE 这个东西，可以在手机端写 Android 应用了。

![](data/img/2018-02-11-421518359524_.pic_hd.jpg)

再再后来呢，自己写了个播放器，主要是因为总改原生的播放器，终究是戴着镣铐跳舞。这个播放器拥有可以旋转的专辑图，带过渡动画的歌词显示（其实是个 ListView），模糊背景之类的东西。

最让人记忆犹新的是歌词解析和顶栏沉浸。

### 歌词解析是怎么个幺蛾子

因为是个本地播放器，歌词这种东西只能一靠嵌入、二靠查找、三靠 API 了——最终就导致，我拿到的 LRC 歌词有各种标准和非标准的格式。最蛋疼的是，如果没用过 PC 古董**千千静听**的话，你也许不知道 LRC 有**压缩**这种操作，而且有两种语法上互相矛盾的压缩方式：一个是把文字内容相同的多句歌词写在一行，**这一行前面放多个标签**；另一个是一行一个标签，**然后把换行符砍掉**。这就导致一个冲突：**对于两个挨在一起的标签，你没法直观判断到底是重复唱的，还是一个空行加一个有歌词的行，中间去掉换行符造成的。**

当时尝试理解各种非标准 LRC 格式的时候，越想越思考人生。最后的方案是，数一下歌词一共有几个换行符，如果换行符少得可怜，那就把所有标签分成单独的行，一行一个标签；不然就按第一种，把挨在一起的标签解析成唱两次。

在那个连 Gradle 都没有的 Eclipse 时代，类库几乎是不存在的，尤其是像 LRC 歌词解析这种国内才有的事，肯定是找不到类库的，况且当时的我也不会用类库。而且那时候我**根本不会正则表达式，不知道那是个什么鬼**。所以这个歌词解析，你们猜我怎么做的。

我他妈愣是用`split`跟`replaceAll`写完的。没错，所有标准和非标准格式，还带解析 offset 的。虽然那个算法一共一百来行代码，然而 Java 的代码量可不是行数能衡量的，还得看**行的长度**。（笑）

最后呢，看上面最后一张图，我还算把这个歌词解析给复用一下，写了个随附的歌词编辑器，长按歌词栏可以调出。我现在还清楚记得底下五个按钮的功能：第一个是**模式切换**，在文本模式和列表模式之间切换，文本模式可以直接编辑，列表模式可以做歌词同步；第二个是**操作切换**，可以切换添加、删除还是替换时间标签，然后在列表模式下点击对应的行可以为那一行做对应的操作。第三个是**播放暂停**，第四个是一系列**智能操作**（批量去掉带小括号、中括号、大括号的不同格式的逐字精准时间戳，去除所有标签，等等）；最后一个按钮当然是**保存**了。

### 顶栏沉浸又是怎么个幺蛾子

看到版本号你就知道了：`Android 4.0.3`。

对，那个版本**根本没顶栏沉浸**，连**顶栏变纯色的实现都没有**。

我愣是通过 `Intent`，在播放器切歌的时候扔了个硕大的 `Bundle` 出去。然后我单独写了个 `ImageView` 可以接受这个 `Bundle`，自动把里面的图片贴自己脸上。接下来的操作把我自己也惊呆了：我编译这个`ImageView`，把编译好的东西反编译成 `smali` 字节码，然后把 `SystemUI` 反编译了，把我的 `ImageView` 字节码扔进去编译，然后 `xml` 里面正常用我的 `ImageView`。

放到现在，哪有那种做实验的闲心；可是当时真的就是有闲心，所以做了这么个实验，结果居然成功了，**我得到了一个可以自动接收 `Intent`，把 `Bundle` 里的图片贴自己脸上的通知栏**。

上图③④便是顶栏沉浸的实装效果，其中③明显一些。

---

高三的时候，除了手机，我还**买了个表**。

![](data/img/2018-02-11-152235.jpg)

智器（也就是现在的华米）Z1 的表，500 块不到的价格非常亲民，搭载垃圾 mips 架构，安卓 4.1 系统，240x240 分辨率。本身几乎没有什么功能，**可它是安卓啊**。

高三的那段时间，一开始为它写了个全屏魔改版 2048，因为安卓表这种东西是灰色地带，没有老师管，上课随便玩。然后画风逐渐变成了**全班男生轮流抢我~~的表~~玩**。最后我也只好晚自习蹲到厕所去，一蹲二十分钟，从 2 打到 2048，爽够了出来接着刷题。

再后来，为它写了个 Launcher，因为原生的 Launcher 太丑了。因为强迫症的原因，那个 Launcher 功能越写越多，UI 越写越精。首屏放上了时间、高考倒计时和快捷图标；后面则是正常的图标屏，可以长按任意图标进入编辑状态，编辑状态可以隐藏图标。

发现什么问题没有？**可以长按任意图标进入编辑状态，编辑状态可以隐藏图标。**如果编辑状态下把所有图标隐藏了，那就再也进不了编辑状态，再也找不回图标了。没错，我设计的时候就考虑到了，但是没打算修复，因为这是给自己留的一个特殊功能：

**高考倒计时 50 天的时候，我深吸一口气，进入编辑状态，把所有图标隐藏了。**

机智如我。高考结束之后，连上 adb，随便装个 apk，就又能进编辑模式了。

---

大一入学，看到小猴偷米公众号的推送，写了个非常简陋且奇葩的简历，以 Android 开发的名义加入了先声网。交了一次开营作业之后，再也没有去过位于行政楼的办公室，当时觉得可能是因为没有钥匙，跟大家不熟吧。**事实是，原属于党宣的先声网在那个学期被党宣扫地出门，不再允许以先声网名义开展活动。**说来也很奇怪，先声网本来是学校管制下的喉舌，不知什么时候主营业务转移到了校园服务，之前做的媒体业务也早就淡化了。

**先声网从此面临「废站危机」**——事实是，本来作为一个有头有脸、有子域名、有办公室的官方组织，从此要变成一个普通社团。毕竟在现在这个环境下，能稳定挂靠学校官方肯定要有两把刷子吧。（笑）

但先声网是不服输的。当时任站长的**[界神](https://github.com/liang-jie)**，走街串巷，找到了位于大活的学生处办公室，以给学办工作提供无偿技术支持为筹码，得到了挂靠学生处的机会，得到了大活的一间办公室。——显然，跟党宣比起来，学生处的老师就和善的多了。

这一折腾，就到了大一的寒假。大概是寒假期间，大家去了行政楼，搬走了办公室和地下车库里我们尘封多年的各种东西，也看到了先声从党媒喉舌逐渐走成技术团体，逐渐走出一条自己的路的历程。再后来，大家在教七开了个会，决定借用微信公众号名称，以**小猴偷米工作室**名义继续开展社团工作，同时也和**[东神](https://github.com/yongdonghe)**定下了小猴偷米 Android 版开发的里程碑。

没错，当时就没考虑 iOS；iOS 的事情将在 iOS 自述文档中提及。

接手小猴 App 的时候，还不会做这种中型项目，所以自己先去写了课表助手的独立 App，小猴 App 这边先让东神搭起框架，做出了一个半模块化的开发框架之后，我就开始写各种模块了。

![](data/img/2018-02-12-431518399407_.pic_hd.jpg)

图为：当时的「课表助手」独立 App，以及那年春节的小猴推送。写完各个模块之后，一个巨大的问题浮现在我们眼前：**首页放什么？**如果按之前的通行做法，首页做一个 `GridView` 放各个模块的入口，但当时根据客串产品的敏感神经，觉得这样十分不优雅。

忽然有一天，似乎是上课的时候，灵机一动：**首页放各个模块的聚合信息。**一开始的想法是按时间轴顺序排列，像刷微博一样看首页，后来发现这个时间参数既不好计算，也没有什么实际意义，就去掉了，改为自己的一套优先级顺序：有提醒 > 有内容 > 无内容。

![](data/img/2018-02-12-441518399584_.pic_hd.jpg)

图为最早的小猴 Android 版 UI，以及下学期开学时装了 OS X 虚拟机搞出来的 iOS 版课表助手。不得不说 iOS 开发上手真快。在后来的 iOS 开发中，手里的安卓机淘汰掉了，淘汰之前还做了个单机球球小游戏，之后也没有再接触过 Android 开发，只是在之前提到的暑期实训中给安卓组的同学们讲了点段子，加了个油。

![](data/img/2018-02-12-2.jpg)

图为现在的 Android 版（iOS 版与 Android 版像素级对应）、小程序，以及今天刚刚做的 2018 新春定制版小程序皮肤。UI 小姐姐是我，这些 UI 都是我自己搞的。

**你问图是怎么截的？**我有三个手机？你信吗。

「全文完」

2018/2/12
